name: Build TQUIC iOS10

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-14

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ----------------------------
      # 1️⃣ 安装 Rust
      # ----------------------------
      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: aarch64-apple-ios

      # ----------------------------
      # 2️⃣ Clone TQUIC v1.6.0
      # ----------------------------
      - name: Clone TQUIC
        run: |
          git clone --branch v1.6.0 https://github.com/Tencent/tquic.git

      # ----------------------------
      # 3️⃣ Clone OpenSSL
      # ----------------------------
      - name: Clone OpenSSL
        run: |
          git clone https://github.com/openssl/openssl.git
          cd openssl
          git checkout openssl-3.2.0

      # ----------------------------
      # 4️⃣ 编译 OpenSSL (iOS10 arm64)
      # ----------------------------
      - name: Build OpenSSL (iOS10 arm64)
        run: |
          set -e

          IOS_MIN=10.0
          BUILD_DIR=$PWD/openssl-ios
          mkdir -p $BUILD_DIR

          cd openssl

          export CROSS_TOP=$(xcode-select -p)/Platforms/iPhoneOS.platform/Developer
          export CROSS_SDK=iPhoneOS.sdk
          export IPHONEOS_DEPLOYMENT_TARGET=$IOS_MIN

          ./Configure ios64-cross no-shared no-dso \
            --prefix=$BUILD_DIR \
            -fembed-bitcode \
            -mios-version-min=$IOS_MIN

          make -j$(sysctl -n hw.ncpu)
          make install_sw

      # ----------------------------
      # 5️⃣ 编译 TQUIC
      # ----------------------------
      - name: Build TQUIC (iOS arm64)
        run: |
          set -e

          export IPHONEOS_DEPLOYMENT_TARGET=10.0

          export OPENSSL_DIR=$PWD/openssl-ios
          export OPENSSL_LIB_DIR=$OPENSSL_DIR/lib
          export OPENSSL_INCLUDE_DIR=$OPENSSL_DIR/include

          cd tquic

          cargo build \
            --target aarch64-apple-ios \
            --release \
            --features vendored-openssl

      # ----------------------------
      # 6️⃣ 输出产物
      # ----------------------------
      - name: Upload libtquic.a
        uses: actions/upload-artifact@v4
        with:
          name: libtquic-ios-arm64
          path: tquic/target/aarch64-apple-ios/release/libtquic.a
