name: Build TQUIC v1.6.0 iOS SDK

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build-ios:
    runs-on: macos-latest
    env:
      RUSTUP_HOME: ${{ github.workspace }}/.rustup
      CARGO_HOME: ${{ github.workspace }}/.cargo

    steps:
      # 1Ô∏è‚É£ Checkout v1.6.0 tag with submodules
      - name: Checkout TQUIC v1.6.0
        uses: actions/checkout@v4
        with:
          repository: Tencent/tquic
          ref: v1.6.0
          submodules: recursive

      # 2Ô∏è‚É£ Install Xcode CLI tools
      - name: Install Xcode Command Line Tools
        run: |
          xcode-select --install || echo "Xcode CLI already installed"

      # 3Ô∏è‚É£ Accept Xcode license
      - name: Accept Xcode license
        run: sudo xcodebuild -license accept

      # 4Ô∏è‚É£ Set SDKROOT
      - name: Set SDKROOT
        run: |
          export SDKROOT=$(xcrun --sdk iphoneos --show-sdk-path)
          echo "SDKROOT=$SDKROOT"

      # 4.1Ô∏è‚É£ Set minimum iOS deployment target
      - name: Set iOS deployment target
        run: echo "Setting IPHONEOS_DEPLOYMENT_TARGET=10.0" && export IPHONEOS_DEPLOYMENT_TARGET=10.0

      # 5Ô∏è‚É£ Install Rust stable
      - name: Install Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      # 6Ô∏è‚É£ Add iOS Rust targets
      - name: Add iOS targets
        run: |
          rustup target add aarch64-apple-ios x86_64-apple-ios aarch64-apple-ios-sim

      # 7Ô∏è‚É£ Install cargo-lipo
      - name: Install cargo-lipo
        run: cargo install cargo-lipo

      # 8Ô∏è‚É£ Build iOS universal library (verbose)
      - name: Build TQUIC universal library
        env:
          IPHONEOS_DEPLOYMENT_TARGET: 10.0   # ‚úÖ Á°Æ‰øùÁºñËØëÊó∂ÁîüÊïà
        run: cargo lipo --features ffi --release --verbose

      # 9Ô∏è‚É£ Prepare SDK structure
      - name: Prepare SDK layout
        run: |
          mkdir -p TQUIC-iOS/lib
          mkdir -p TQUIC-iOS/include
          cp target/universal/release/*.a TQUIC-iOS/lib/libtquic.a
          cp -R include/* TQUIC-iOS/include/

      # üîü Zip SDK
      - name: Zip SDK
        run: zip -r TQUIC-iOS-v1.6.0.zip TQUIC-iOS

      # 1Ô∏è‚É£1Ô∏è‚É£ Upload artifact
      - name: Upload SDK artifact
        uses: actions/upload-artifact@v4
        with:
          name: tquic-ios-sdk-v1.6.0
          path: TQUIC-iOS-v1.6.0.zip
